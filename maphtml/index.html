<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Маршрут с ETA - HTML/JS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: Arial; }
    body { display: flex; }
    #leftPanel { flex: 3; display: flex; flex-direction: column; height: 100vh; }
    #controls { padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ccc; }
    #map { flex: 1; width: 100%; }
    #infoPanel { flex: 1; padding: 20px; background: #f9f9f9; border-left: 1px solid #ccc; min-width: 250px; overflow-y:auto; }
    input { padding:5px; width:100px; }
    button { padding:6px 12px; cursor:pointer; }
  </style>
</head>
<body>

<div id="leftPanel">
  <div id="controls">
    Въведи минути:
    <input type="number" id="minutesInput" value="" min="0">
    <button onclick="updateProgress()">Покажи</button>
  </div>
  <div id="map"></div>
</div>

<div id="infoPanel">
  <h3>Информация</h3>
  <p id="formattedTime">Общо време: -</p>
  <p id="percentInfo">Прогрес: -</p>
  <p id="expectedTime">Очаквано време: -</p>
  <h4>ETA за градовете:</h4>
  <ul id="citiesETA"></ul>
</div>

<script>
// ===== КАРТА =====
let map = L.map('map').setView([42.7, 25.0], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

map.createPane('routePane');
map.createPane('markerPane');
map.getPane('routePane').style.zIndex = 400;
map.getPane('markerPane').style.zIndex = 650;

// ===== ДАННИ ЗА ГРАДОВЕТЕ =====
let cities = [
  { "name": "София", "coords": [42.6977, 23.3219], "address": "бул. Цариградско шосе 115" },
  { "name": "Пловдив", "coords": [42.1354, 24.7453], "address": "бул. България 236" },
  { "name": "Стара Загора", "coords": [42.4258, 25.6345], "address": "бул. Славянски 54" },
  { "name": "Бургас", "coords": [42.5048, 27.4626], "address": "ул. Александровска 26" }
];

let cityMarkers = [];
let fullRoutePoints = [];
let greenLine, currentMarker;
const avgSpeedKmh = 80;

// ===== ФУНКЦИИ =====
function getDistanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function formatMinutes(minutes) {
  let hours = Math.floor(minutes / 60);
  let mins = Math.floor(minutes % 60);
  return hours + " ч " + (mins<10?"0"+mins:mins) + " мин";
}

function getProgressPoint(points, percent) {
  let totalSegments = points.length - 1;
  let segmentProgress = percent * totalSegments;
  let currentSegment = Math.floor(segmentProgress);
  let segmentFraction = segmentProgress - currentSegment;
  if (currentSegment >= totalSegments) return points[points.length - 1];
  let start = points[currentSegment];
  let end = points[currentSegment + 1];
  let lat = start[0] + (end[0] - start[0]) * segmentFraction;
  let lng = start[1] + (end[1] - start[1]) * segmentFraction;
  return [lat, lng];
}

function getGreenRoute(points, percent) {
  let totalSegments = points.length - 1;
  let segmentProgress = percent * totalSegments;
  let currentSegment = Math.floor(segmentProgress);
  let segmentFraction = segmentProgress - currentSegment;

  let progressPoints = points.slice(0, currentSegment + 1);
  if (currentSegment < totalSegments) {
    let start = points[currentSegment];
    let end = points[currentSegment + 1];
    let lat = start[0] + (end[0] - start[0]) * segmentFraction;
    let lng = start[1] + (end[1] - start[1]) * segmentFraction;
    progressPoints.push([lat, lng]);
  }
  return progressPoints;
}

function calculateTotalTime(points, avgSpeed) {
  let totalKm = 0;
  for (let i=0;i<points.length-1;i++){
    totalKm += getDistanceKm(points[i][0], points[i][1], points[i+1][0], points[i+1][1]);
  }
  return Math.round((totalKm / avgSpeed) * 60);
}

function getDistanceAlongRoute(points, currentIndex, segmentFraction) {
  let dist = 0;
  for (let i = 0; i < currentIndex; i++) {
    dist += getDistanceKm(points[i][0], points[i][1], points[i+1][0], points[i+1][1]);
  }
  dist += getDistanceKm(points[currentIndex][0], points[currentIndex][1],
                        points[currentIndex+1][0], points[currentIndex+1][1]) * segmentFraction;
  return dist;
}

function calculateETA(distanceKm) {
  return distanceKm / avgSpeedKmh * 60;
}

function getRouteDistanceToCity(cityIndex) {
  let dist = 0;
  for (let i = 0; i < fullRoutePoints.length - 1; i++) {
    const segStart = fullRoutePoints[i];
    const segEnd = fullRoutePoints[i+1];
    dist += getDistanceKm(segStart[0], segStart[1], segEnd[0], segEnd[1]);
    const city = cities[cityIndex];
    const dToCity = getDistanceKm(segEnd[0], segEnd[1], city.coords[0], city.coords[1]);
    if (dToCity < 0.05) break;
  }
  return dist;
}

function getRouteDistanceToPercent(percent){
  const totalSegments = fullRoutePoints.length -1;
  const segmentProgress = percent * totalSegments;
  const currentSegment = Math.floor(segmentProgress);
  const segmentFraction = segmentProgress - currentSegment;
  return getDistanceAlongRoute(fullRoutePoints, currentSegment, segmentFraction);
}

// ===== ПРАВИЛЕН СЛЕДВАЩ ГРАД =====
function getNextCityByProgress(distanceTraveledKm) {
  for (let i = 1; i < cities.length; i++) {
    const cityDistance = getRouteDistanceToCity(i);
    if (cityDistance > distanceTraveledKm) {
      return { city: cities[i], remainingKm: Math.round(cityDistance - distanceTraveledKm) };
    }
  }
  return { city: cities[cities.length-1], remainingKm: 0 };
}

// ===== ОБНОВЯВАНЕ ETA С "До ..." =====
function updateCitiesETA() {
  let etaList = document.getElementById("citiesETA");
  etaList.innerHTML = "";
  const totalTravelTimeMinutes = calculateTotalTime(fullRoutePoints, avgSpeedKmh);
  const minutesInput = parseFloat(document.getElementById("minutesInput").value) || 0;
  const percentInput = minutesInput / totalTravelTimeMinutes;
  const distanceTraveledKm = getRouteDistanceToPercent(percentInput);
  
  for (let i=1;i<cities.length;i++){
    const cityDist = getRouteDistanceToCity(i);
    const eta = calculateETA(cityDist);
    let remainingKm = Math.max(0, Math.round(cityDist - distanceTraveledKm));
    let li = document.createElement("li");
    li.textContent = "До " + cities[i].name + ": " + formatMinutes(eta) + " (" + remainingKm + " км)";
    etaList.appendChild(li);
  }
}

// ===== ИНИЦИАЛИЗАЦИЯ =====
function initMap() {
  cities.forEach((city,index)=>{
    let color = index===0?"green":index===cities.length-1?"red":"blue";
    let marker = L.circleMarker(city.coords, { radius:6, color, fillColor:color, fillOpacity:1, pane:'markerPane'})
      .addTo(map)
      .bindPopup("<b>"+city.name+"</b><br>Адрес: "+city.address);
    cityMarkers.push(marker);
  });

  let routeControl = L.Routing.control({
      waypoints: cities.map(c => L.latLng(c.coords[0], c.coords[1])),
      lineOptions: { styles: [{ color: 'blue', weight: 5 }] },
      addWaypoints: false,
      routeWhileDragging: false,
      draggableWaypoints: false,
      show: false,
      createMarker: function() { return null; }
  }).addTo(map);

  routeControl.on('routesfound', function(e) {
      const route = e.routes[0];
      fullRoutePoints = route.coordinates.map(c => [c.lat, c.lng]);
      L.polyline(fullRoutePoints, { color: 'blue', weight: 5, pane:'routePane' }).addTo(map);
      map.fitBounds(route.bounds);

      const totalTravelTimeMinutes = calculateTotalTime(fullRoutePoints, avgSpeedKmh);
      document.getElementById("expectedTime").innerText =
        "Очаквано време: " + formatMinutes(totalTravelTimeMinutes) + " ("+totalTravelTimeMinutes+" мин)";

      updateCitiesETA();
  });
}

initMap();

// ===== ПРОГРЕС =====
function updateProgress() {
  if (!fullRoutePoints.length) return;

  const minutesInput = document.getElementById("minutesInput").value;
  const totalTravelTimeMinutes = calculateTotalTime(fullRoutePoints, avgSpeedKmh);

  if (minutesInput === "" || parseFloat(minutesInput) <= 0) {
    if (greenLine) map.removeLayer(greenLine);
    if (currentMarker) map.removeLayer(currentMarker);
    L.polyline(fullRoutePoints, { color: 'blue', weight: 5, pane: 'routePane' }).addTo(map);
    document.getElementById("formattedTime").innerText = "Общо време: -";
    document.getElementById("percentInfo").innerText = "Прогрес: -";
    document.getElementById("expectedTime").innerText =
      "Очаквано време: " + formatMinutes(totalTravelTimeMinutes) + " ("+totalTravelTimeMinutes+" мин)";
    updateCitiesETA();
    map.fitBounds(fullRoutePoints);
    return;
  }

  const minutes = parseFloat(minutesInput);
  let percent = minutes / totalTravelTimeMinutes;
  if (percent>1) percent=1;

  const greenRoute = getGreenRoute(fullRoutePoints, percent);
  const totalSegments = fullRoutePoints.length - 1;
  const segmentProgress = percent * totalSegments;
  const currentSegment = Math.floor(segmentProgress);
  const segmentFraction = segmentProgress - currentSegment;

  const distanceTraveledKm = getDistanceAlongRoute(fullRoutePoints, currentSegment, segmentFraction);
  const etaMinutes = calculateETA(distanceTraveledKm);

  const currentPosition = getProgressPoint(fullRoutePoints, percent);

  if (greenLine) map.removeLayer(greenLine);
  if (currentMarker) map.removeLayer(currentMarker);

  greenLine = L.polyline(greenRoute, { color: 'green', weight: 6, pane: 'routePane' }).addTo(map);

  // правилен следващ град
  const nextCityInfo = getNextCityByProgress(distanceTraveledKm);
  const nextCity = nextCityInfo.city;
  const remainingKm = nextCityInfo.remainingKm;

  currentMarker = L.circleMarker(currentPosition, {
      radius: 8,
      color: 'orange',
      weight: 3,
      fillColor: 'yellow',
      fillOpacity: 1,
      pane:'markerPane'
  })
  .addTo(map)
  .bindPopup(
    "<b>Текуща позиция</b><br>" +
    "След " + formatMinutes(minutes) + "<br>" +
    "До " + nextCity.name + " има още " + remainingKm + " км<br>" +
    "ETA от началото: " + formatMinutes(etaMinutes)
  );

  document.getElementById("formattedTime").innerText = "Общо време: " + formatMinutes(minutes);
  document.getElementById("percentInfo").innerText = "Прогрес: " + Math.round(percent*100) + "%";
    document.getElementById("expectedTime").innerText =
    "Очаквано време: " + formatMinutes(totalTravelTimeMinutes) + " ("+totalTravelTimeMinutes+" мин)";

  updateCitiesETA();

  map.panTo(currentPosition);
}
</script>

</body>
</html>
